<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Настройки профиля</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<div id="navbar-container"></div>
<script type="module" src="/js/auth.js"></script>

<div class="container mt-5 mb-5">
    <h2>Настройки профиля</h2>
    <p>Текущее имя: <strong id="currentUsernameDisplay"></strong></p>
    
    <form id="updateUsernameForm" class="mb-4">
        <div class="mb-3">
            <label for="newUsername" class="form-label">Новое имя</label>
            <input type="text" class="form-control" id="newUsername" required>
        </div>
        <button type="submit" class="btn btn-primary">Сохранить</button>
    </form>
    
    <button id="deleteAccountButton" class="btn btn-danger mt-3">Удалить аккаунт</button>
    <a href="/profile.html" class="d-block mt-3">&larr; Назад в профиль</a>
</div>

<script type="module">
import { checkAuth, clearAuthData } from './js/auth.js';

document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login.html';
        return;
    }

    try {
        const user = await checkAuth(token);
        if (!user || user.error === 'User not found') {
            clearAuthData();
            window.location.href = '/login.html';
            return;
        }

        // Отображаем текущее имя
        document.getElementById('currentUsernameDisplay').textContent = user.username || 'Не указано';

        // Обработчик формы
        document.getElementById('updateUsernameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value.trim();
            
            if (!newUsername) {
                alert('Введите новое имя');
                return;
            }

            try {
                const response = await fetch('api/user/rename', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newUsername })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка сервера');
                }

                // Обновляем интерфейс
                document.getElementById('currentUsernameDisplay').textContent = newUsername;
                localStorage.setItem('username', newUsername);
                alert('Имя успешно изменено!');
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert(error.message || 'Не удалось изменить имя');
            }
        });

        // Обработчик удаления
        document.getElementById('deleteAccountButton').addEventListener('click', async () => {
            if (confirm('Вы уверены? Это действие нельзя отменить!')) {
                try {
                    const response = await fetch('/api/user/delete', {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Детали ошибки:', errorData);
                        throw new Error(errorData.error || 'Не удалось удалить аккаунт');
                    }

                    clearAuthData();
                    alert('Аккаунт удалён');
                    window.location.href = '/';
                } catch (error) {
                    console.error('Полная ошибка:', error);
                    alert(error.message);
                }
            }
        });

    } catch (error) {
        console.error('Ошибка проверки авторизации:', error);
        clearAuthData();
        window.location.href = '/login.html';
    }
});

// Загрузка шапки
fetch('/nav.html')
    .then(res => res.text())
    .then(html => document.getElementById('navbar-container').innerHTML = html)
    .catch(err => console.error('Ошибка загрузки шапки:', err));
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>