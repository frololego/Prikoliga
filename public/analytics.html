<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">    
    <!-- –ù–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å—Ç–∏–ª—å -->
    <link rel="stylesheet" href="/style.css">
    <style>
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        .loading-placeholder {
            height: 60px;
            background: #f5f5f5;
            border-radius: 4px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gold { color: #FFD700; }
        .silver { color: #C0C0C0; }
        .bronze { color: #CD7F32; }
        .medal-icon { font-size: 1.2em; }
    </style>
</head>
<body>
<!-- === –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–ø–∫–∏ === -->
<div id="navbar-container">
    <div class="loading-placeholder">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
<div class="container mt-4">
    <h1 class="mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h1>
    
    <div class="table-container p-3">
        <div id="table-loading" class="loading-placeholder">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
            </div>
        </div>
        <table class="table table-striped table-hover d-none" id="analytics-table">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th><i class="bi bi-people">
                    <th><i class="bi bi-hourglass-split">
                    <th><i class="bi bi-check-square">
                    <th><i class="bi bi-exclamation-triangle">
                    <th>%</th>
                    <th><i class="bi bi-trophy">
                    <th><i class="bi bi-star">
                </tr>
            </thead>
            <tbody id="users-table">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
<script type="module">
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–ø–∫—É
    async function loadNavbar() {
        try {
            const response = await fetch('/nav.html');
            if (!response.ok) throw new Error('–®–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            
            document.getElementById('navbar-container').innerHTML = await response.text();
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º nav.js –µ—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω
            try {
                await import('/js/nav.js');
            } catch (e) {
                console.log('Nav.js –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–ø–∫–∏:', error);
            document.getElementById('navbar-container').innerHTML = `
                <div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é</div>
            `;
        }
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –º–µ–¥–∞–ª—è–º–∏
    function renderAnalyticsTable(users) {
        const container = document.getElementById('users-table');
        if (!container) {
            console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä users-table –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
        const sortedUsers = [...users].sort((a, b) => (b.rating || 0) - (a.rating || 0));

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç
        const groupedUsers = groupUsersByRating(sortedUsers);

        container.innerHTML = sortedUsers.map((user, index) => {
            const position = getUserPosition(groupedUsers, user.rating || 0);
            const points = (user.correct || 0) * 3 + (user.partial || 0) * 1;
            
            return `
                <tr>
                    <td>${position}</td>
                    <td>${escapeHtml(user.username || 'N/A')}</td>
                    <td>${user.finishedPredictions || 0}</td>
                    <td>${user.correct || 0}</td>
                    <td>${user.partial || 0}</td>
                    <td>${user.accuracyPercentage != null ? user.accuracyPercentage + '%' : 'N/A'}</td>
                    <td>${points}</td>
                    <td class="${getMedalClass(position)}">
                        ${getRatingDisplay(position)}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // 3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç
    function groupUsersByRating(users) {
        const groups = {};
        let currentRank = 1;
        
        users.forEach((user, index) => {
            const rating = user.rating || 0;
            
            if (!groups[rating]) {
                groups[rating] = {
                    start: currentRank,
                    count: 1
                };
                currentRank++;
            } else {
                groups[rating].count++;
                currentRank++;
            }
        });
        
        return groups;
    }

    // 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getUserPosition(groups, rating) {
        const group = groups[rating];
        return group ? group.start : Object.keys(groups).length + 1;
    }

    // 5. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è –º–µ–¥–∞–ª–∏
    function getMedalClass(position) {
        switch(position) {
            case 1: return 'gold';
            case 2: return 'silver';
            case 3: return 'bronze';
            default: return '';
        }
    }

    // 6. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ (–º–µ–¥–∞–ª–∏ –∏–ª–∏ —Ü–∏—Ñ—Ä—ã)
    function getRatingDisplay(position) {
        switch(position) {
            case 1: return 'ü•á';
            case 2: return 'ü•à';
            case 3: return 'ü•â';
            default: return position;
        }
    }

    // 7. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(str) {
        return str ? str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;') : '';
    }

    // 8. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
        await loadNavbar();
        
        try {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const token = localStorage.getItem('token');
            if (!token) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            const response = await fetch('/api/analytics', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }

            const analyticsData = await response.json();
            
            if (!Array.isArray(analyticsData)) {
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
            renderAnalyticsTable(analyticsData);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            document.getElementById('table-loading').classList.add('d-none');
            document.getElementById('analytics-table').classList.remove('d-none');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            document.getElementById('table-loading').innerHTML = `
                <div class="alert alert-danger">
                    ${escapeHtml(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.')}
                </div>
            `;
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>